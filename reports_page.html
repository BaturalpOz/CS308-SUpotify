<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://bootswatch.com/4/lux/bootstrap.min.css"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link
      rel="stylesheet"
      href="assets/fontawesome-free-6.5.1-web/css/all.css"
    />

    <title>Reports</title>
    <style>
      /* Styles for navbar, form, and report display */
      .navbar {
        background-color: #0f4c8f;
        padding: 10px;
        text-align: left;
      }
      .navbar h1 {
        margin: 0;
        padding: 0;
        color: white;
        font-size: 24px;
      }
      .container {
        padding-top: 20px;
      }
      .form-group {
        margin-bottom: 10px;
      }
      canvas {
        max-width: 600px;
        max-height: 400px;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-bottom">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">© 2023 SUpotify</a>
      </div>
    </nav>

    <nav class="navbar navbar-expand-lg">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">SUpotify</a>
      </div>
    </nav>

    <div class="container">
      <h2>Generate and Retrieve Reports</h2>
      <form id="reportForm" onsubmit="return false;">
        <div class="form-group">
          <label for="startDate">Start Date:</label>
          <input type="date" id="startDate" class="form-control" required />
        </div>
        <div class="form-group">
          <label for="endDate">End Date:</label>
          <input type="date" id="endDate" class="form-control" required />
        </div>
        <div class="form-group">
          <label for="filterType">Filter Type:</label>
          <select id="filterType" class="form-control">
            <option value="songs">Songs</option>
            <option value="albums">Albums</option>
            <option value="artists">Artists</option>
          </select>
        </div>
        <button
          type="submit"
          class="btn btn-primary"
          onclick="get_statistics_user()"
        >
          Generate Report
        </button>
      </form>
      <div id="reportData">
        <!-- Report data will be displayed here -->
      </div>
    </div>

    <script>
      // Function to handle report generation
      function get_statistics_user() {
    var startDate = $("#startDate").val();
    var endDate = $("#endDate").val();
    var filterType = $("#filterType").val();

    $.ajax({
        url: "http://127.0.0.1:5001/user/statistics-user", // Flask backend URL'nizi buraya ayarlayın
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({
            start_date: startDate,
            end_date: endDate,
            filter_type: filterType,
        }),
        xhrFields: {
            withCredentials: true,
        },
        headers: {
            cookie: document.cookie,
        },
        success: function (data) {
            $("canvas#chart").remove();
            $("#reportData").append(`<canvas id="chart"></canvas>`);
            var ctx = document.getElementById("chart").getContext("2d");

            var ratedArtistsData = data.rated_artists.map(function (item) {
                return {
                    x: new Date(item.date).getTime(),
                    y: item.artist.rating,
                };
            });

            var ratedSongsData = data.rated_songs.map(function (item) {
                return {
                    x: new Date(item.date).getTime(),
                    y: item.song.rating,
                };
            });

            var ratedAlbumsData = data.rated_albums.map(function (item) {
                return {
                    x: new Date(item.date).getTime(),
                    y: item.album.rating,
                };
            });

            window.myChart = new Chart(ctx, {
                type: "line",
                data: {
                    datasets: [
                        {
                            label: "Rated Artists",
                            data: ratedArtistsData,
                            borderColor: "rgba(75, 192, 192, 1)",
                            backgroundColor: "rgba(75, 192, 192, 0.2)",
                        },
                        {
                            label: "Rated Songs",
                            data: ratedSongsData,
                            borderColor: "rgba(255, 99, 132, 1)",
                            backgroundColor: "rgba(255, 99, 132, 0.2)",
                        },
                        {
                            label: "Rated Albums",
                            data: ratedAlbumsData,
                            borderColor: "rgba(54, 162, 235, 1)",
                            backgroundColor: "rgba(54, 162, 235, 0.2)",
                        }
                    ],
                },
                options: {
                    scales: {
                        x: {
                            type: "time",
                            time: {
                                unit: "day",
                            },
                            title: {
                                display: true,
                                text: "Date",
                            },
                        },
                        y: {
                            title: {
                                display: true,
                                text: "Rating",
                            },
                        },
                    },
                },
            });
        },
        error: function (error) {
            console.error(error);
            var errorMessage = error.responseJSON
                ? error.responseJSON.error
                : "Veri alınırken hata oluştu";
            $("#errorMessage").text(errorMessage);
        },
    });
}

$(document).ready(function () {
    $("#reportForm").on("submit", function (e) {
        e.preventDefault();
        get_statistics_user();
    });
});


      // Event listener for the report generation button
      $(document).ready(function () {
        $("#reportForm").on("submit", function (e) {
          e.preventDefault();
          get_statistics_user();
        });
      });
    </script>
  </body>
</html>
